<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Zero to Hero with End-to-End testing using Nightwatch, SauceLabs and Travis</title>
  <meta name="description" content="Developing super cool web apps has always been a walk on a thin line: You want to use the latest possible language features and APIs, but at the same time, i...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="canonical" href="http://mikbe.com/javascript/ci/testing/2016/01/23/zero-to-hero-with-end-to-end-testing.html">
  <link rel="alternate" type="application/rss+xml" title="Mikbe.com" href="http://mikbe.com/feed.xml">
</head>


  <body>

    
      <div class="transparent">
        <section class="hero is-info is-left is-bold">
  <div class="hero-header">
    <header class="header">

      <!-- Left side -->
      <div class="header-left">
        <div class="header-item">
          <a class="header-item" href="/">
            <h1 class="title">Mikbe.com</h1>
          </a>
        </div>
      </div>

      <!-- Right side -->
      <div class="header-right">
        
          
        
          
        
          
        
      </div>

    </heaer>
  </div>
</section>

      </div>
      <div class="heroimg">
        <img src="/images/pink-fluffy-clouds.jpg">
      </div>
    

    <section class="section">
      <div class="container">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

          <header class="heading">
            <h1 class="title" itemprop="name headline">Zero to Hero with End-to-End testing using Nightwatch, SauceLabs and Travis</h1>
            <p class="post-meta"><time datetime="2016-01-23T13:59:43+00:00" itemprop="datePublished">Jan 23, 2016</time></p>
          </header>

          <div class="content" itemprop="articleBody">
            <p>Developing super cool web apps has always been a walk on a thin line: You want to use the latest possible language features and APIs, but at the same time, it needs to work in loads of, for developers, obscure browsers like IE10 and Android Browser.</p>

<p>Deploying quickly grinds to a holt when you find out in final tests that your app doesn’t work in all of the required browsers and environments, and last minute hacks are sometimes needed. Using a continuous integration testing tool with real-life browsers was a real timesaver and stress-reliever for me.</p>

<p>This is a summary of the feature branch that took me there.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>In order to get something tested at all, we need two ingredients: A <em>browser automation tool</em> and a <em>test runner</em>. For browser automation, <a href="http://www.seleniumhq.org/">Selenium</a> is the obvious option, and the one cloud testing providers like BrowserStack and SauceLabs use.</p>

<p>If you’re on OSX, run <code class="highlighter-rouge">brew install selenium-server-standalone</code>, along with a webdriver for your favourite browser: <code class="highlighter-rouge">brew install chromedriver</code>. Run it with <code class="highlighter-rouge">selenium-server -p 4444</code>.</p>

<p>There are many test runners which integrate with Selenium. You can choose any test runner you want, so choose one that makes sense for you, based on programming language and needs. This article is based on <a href="http://nightwatchjs.org/">Nightwatch</a>, but should be easily translatable for other test runners.</p>

<p>Go ahead and install Nightwatch with <code class="highlighter-rouge">npm install -g nightwatch</code>.</p>

<h2 id="configuring-nightwatch">Configuring Nightwatch</h2>

<p>Nightwatch needs some config, so create a new file called <code class="highlighter-rouge">nightwatch.js</code>. Nightwatch uses a <code class="highlighter-rouge">.json</code> config file as default, but using a JS one allows us to do some smart stuff later, like generating parts of the config based on environment variables.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c1">// nightwatch.js</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">src_folders</span><span class="p">:</span> <span class="p">[</span><span class="s1">'test/e2e/'</span><span class="p">],</span>
  <span class="p">...</span>
<span class="p">};</span>
</code></pre>
</div>

<p>Find the rest of the configuration you need in Nightwatch’ developer guide. In the <code class="highlighter-rouge">default</code> configuration, just use the <code class="highlighter-rouge">browserName</code> corresponding to the Selenium webdriver you installed, e.g. <code class="highlighter-rouge">chrome</code>.</p>

<h2 id="creating-your-first-test">Creating your first test</h2>

<p>Time to write some code! Create a file <code class="highlighter-rouge">test/e2e/simple/simpleTest.js</code>and paste in something like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c1">// test/e2e/simple/simpleTest.js</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">beforeEach</span><span class="p">:</span> <span class="nx">browser</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">browser</span>
      <span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="s1">'http://localhost:8000'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">waitForElementVisible</span><span class="p">(</span><span class="err">‘</span><span class="nx">body</span><span class="err">’</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">waitForElementVisible</span><span class="p">(</span><span class="err">‘#</span><span class="nx">app</span> <span class="o">&gt;</span> <span class="nx">div</span><span class="err">’</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="err">‘</span><span class="nx">Smoke</span> <span class="nx">test</span><span class="err">’</span><span class="p">:</span> <span class="nx">browser</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">browser</span>
      <span class="p">.</span><span class="nx">assert</span><span class="p">.</span><span class="nx">visible</span><span class="p">(</span><span class="err">‘#</span><span class="nx">app</span> <span class="o">&gt;</span> <span class="nx">div</span><span class="err">’</span><span class="p">,</span> <span class="err">‘</span><span class="nx">Check</span> <span class="k">if</span> <span class="nx">app</span> <span class="nx">has</span> <span class="nx">rendered</span> <span class="kd">with</span>   <span class="nx">React</span><span class="err">’</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">assert</span><span class="p">.</span><span class="nx">title</span><span class="p">(</span><span class="err">‘</span><span class="nx">MyTitle</span><span class="err">’</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="na">after</span><span class="p">:</span> <span class="nx">browser</span> <span class="o">=&gt;</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">end</span><span class="p">(),</span>
<span class="p">};</span>
</code></pre>
</div>

<p>Thanks to the Nightwatch API, the code is pretty self explanatory. Replace the assertions with something that makes sense for you.</p>

<p>Assuming you already have your app running, go ahead and run your test, with <code class="highlighter-rouge">nightwatch --config nightwatch.js</code>.</p>

<p><img src="/images/nightwatch.gif" alt="Running Nightwatch" /> <em>Awesome, the title matches the HTML.</em></p>

<h2 id="running-tests-in-the-cloud">Running Tests in the Cloud</h2>

<p>Useful as it is to test whether Chrome can parse HTML, we’re now ready to 10x the awesomeness, using SauceLabs. Feel free to create an account at this point.</p>

<p>First, make some changes to the Nightwatch config:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">default</span><span class="err">:</span> <span class="p">{</span>
  <span class="nl">launch_url</span><span class="p">:</span> <span class="s1">'http://ondemand.saucelabs.com:80'</span><span class="p">,</span>
  <span class="nx">selenium_port</span><span class="err">:</span> <span class="mi">80</span><span class="p">,</span>
  <span class="nx">selenium_host</span><span class="err">:</span> <span class="s1">'ondemand.saucelabs.com'</span><span class="p">,</span>
  <span class="nx">silent</span><span class="err">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nx">username</span><span class="err">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SAUCE_USERNAME</span><span class="p">,</span>
  <span class="nx">access_key</span><span class="err">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SAUCE_ACCESS_KEY</span><span class="p">,</span>
  <span class="nx">screenshots</span><span class="err">:</span> <span class="p">{</span>
    <span class="nl">enabled</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">path</span><span class="err">:</span> <span class="err">‘’</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="nx">globals</span><span class="err">:</span> <span class="p">{</span>
    <span class="nl">waitForConditionTimeout</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">},</span>
</code></pre>
</div>

<p>(You can move your previous default config to one called e.g. “local”.)</p>

<p>Nightwatch needs your username and access key to connect to SauceLabs. We also use the opportunity to add a global default time for Nightwatch’ timeouts.</p>

<p>At the same level as the default configuration, add one or two browsers you want to test against:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">chrome</span><span class="err">:</span> <span class="p">{</span>
  <span class="nl">desiredCapabilities</span><span class="p">:</span> <span class="p">{</span>
    <span class="nl">browserName</span><span class="p">:</span> <span class="s1">'chrome'</span><span class="p">,</span>
    <span class="nx">platform</span><span class="err">:</span> <span class="s1">'OS X 10.11'</span><span class="p">,</span>
    <span class="nx">version</span><span class="err">:</span> <span class="s1">'47'</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">},</span>
<span class="nx">ie11</span><span class="err">:</span> <span class="p">{</span>
  <span class="nl">desiredCapabilities</span><span class="p">:</span> <span class="p">{</span>
    <span class="nl">browserName</span><span class="p">:</span> <span class="s1">'internet explorer'</span><span class="p">,</span>
    <span class="nx">platform</span><span class="err">:</span> <span class="s1">'Windows 10'</span><span class="p">,</span>
    <span class="nx">version</span><span class="err">:</span> <span class="s1">'11.0'</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Set your SauceLabs username and access key environment variables with <code class="highlighter-rouge">export SAUCE_USERNAME &lt;username&gt;</code>.</p>

<p>For SauceLabs to be able to contact your server, install SauceConnect with <code class="highlighter-rouge">brew install sauce-connect</code>, then run it with <code class="highlighter-rouge">sc -u &lt;USERNAME&gt; -k &lt;ACCESS_KEY&gt;</code>.</p>

<p>This should be all it takes to run tests on a machine far, far away, somewhere in a cloud, and have it do stuff the server running right under your fingertips. Run <code class="highlighter-rouge">nightwatch --config nightwatch.js --env chrome</code>, then sit back and relax.</p>

<p><img src="/images/nightwatch-saucelabs.png" alt="Nightwatch on Saucelabs" /> <em>Not bad, Chrome and IE agree on the title.</em></p>

<h2 id="run-your-tests-from-travis">Run Your Tests from Travis</h2>

<p>This step requires us to make Travis spawn both a server to host our app, and a tunnel to SauceLabs with SauceConnect. Worry not, because it’s not that hard.</p>

<p>For more documentation, read <a href="For more documentation, read Travis’ article.">Travis’ article</a>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="s">addons</span><span class="pi">:</span>
  <span class="s">sauce_connect</span><span class="pi">:</span> <span class="s">true</span>
<span class="s">install</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">nvm install 4.0 // if you're not using Node as language</span>
  <span class="pi">-</span> <span class="s">npm install -g nightwatch</span>
<span class="s">before_script</span><span class="pi">:</span>
  <span class="s">// This is our server</span>
  <span class="s">- npm run serve:dist &amp;</span>
<span class="s">script</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">nightwatch --config nightwatch.js --env chrome,ie11</span>
  <span class="s">// This one feels hacky, but does the job of killing the server</span>
  <span class="pi">-</span> <span class="s">pkill node</span>
</code></pre>
</div>

<p><strong>Note:</strong> If your server takes a very long time to load, it can be a good idea to add a “sleep 30” command after you start the server.</p>

<p><strong>Also note:</strong> You probably have some other stuff you want travis to do. Do them before Nightwatch, as the tests involving SauceLabs are probably the most expensive. You’ll also give your server some time to build JavaScript.</p>

<p>For SauceLabs to connect to Travis, we need to send them a tunnel identifier. We’d also like SauceLabs to take a note of the Travis build number it is testing, so we also pass that one. Luckily, they’re both based on the same value.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c1">// nightwatch.js</span>
<span class="kr">const</span> <span class="nx">TRAVIS_JOB_NUMBER</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">TRAVIS_JOB_NUMBER</span><span class="p">;</span>
<span class="c1">// in test_settings.default:</span>
<span class="nl">default</span><span class="p">:</span> <span class="p">{</span>
  <span class="nl">launc_url</span><span class="p">:</span> <span class="s1">'http://ondemand.saucelabs.com:80'</span><span class="p">,</span>
  <span class="p">...</span>
  <span class="nl">desiredCapabilities</span><span class="p">:</span> <span class="p">{</span>
    <span class="nl">build</span><span class="p">:</span> <span class="err">`</span><span class="nx">build</span><span class="o">-</span><span class="nx">$</span><span class="p">{</span><span class="nx">TRAVIS_JOB_NUMBER</span><span class="p">}</span><span class="err">`</span><span class="p">,</span>
    <span class="s1">'tunnel-identifier'</span><span class="err">:</span> <span class="nx">TRAVIS_JOB_NUMBER</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Congratulations, the next time you push your code, servers around the world will collaborate to make sure everything works as intended.</p>

<p>Gather some friends to watch in awe as results tick into the SauceLabs dashboard, with live videos and things flashing all over the screen.</p>

<h2 id="make-saucelabs-know-whether-or-not-it-worked">Make SauceLabs know whether or not it worked</h2>

<p>You might have noticed the nice question mark next to each of your tests in SauceLabs. It appears because while it provided Nightwatch with a nice API for it to run commands an queries, it’s completely oblivious to whether or not it was expected. In order to get some nice check marks (or red exclamation marks), we need to report SauceLabs about the outcomes.</p>

<p><a href="https://gist.github.com/mikberg/ce463e09d6adf46f987c">Here’s an example implementation</a> in the form of a Gist, inspired by <a href="https://github.com/18F/college-choice/blob/8029b46f1283ed94c7f13662689374c399ff6740/test/sauce.js">this code</a>.</p>

<p>Edit your test to run the sauce function when it tears down:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kr">const</span> <span class="nx">sauce</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../sauce'</span><span class="p">);</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="na">tearDown</span><span class="p">:</span> <span class="nx">sauce</span><span class="p">,</span>
<span class="p">};</span>
</code></pre>
</div>

<p>Result:</p>

<p><img src="/images/saucelabs-results.png" alt="Saucelabs results" /></p>

<p>Awesome. Add some better tests, add more obscure browsers, like Android 4.0. Now, only be a little bit nervous about browsers on each commit, rather than terrified when releasing.</p>

          </div>

          
            <div class="heroimgcreds">Hero image: <p>Header image is licensed under a Creative Commons Attribution-Noncommercial-No Derivative Works 3.0 License. http://creativecommons.org/licenses/by-nc-nd/3.0/ Font Credit: http://www.pia-frauss.de/</p>
</div>
          

          <hr>

          <div class="share">
              <h4 class="subtitle">Share this post and be extra cool</h4>
              <a class="fa fa-twitter" href="http://twitter.com/share?text=Zero to Hero with End-to-End testing using Nightwatch, SauceLabs and Travis&amp;url=http://mikbe.comjavascriptcitesting20160123zero-to-hero-with-end-to-end-testing.html"
                  onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                  <span class="hidden">Twitter</span>
              </a>
              <a class="fa fa-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://mikbe.comjavascriptcitesting20160123zero-to-hero-with-end-to-end-testing.html"
                  onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                  <span class="hidden">Facebook</span>
              </a>
              <a class="fa fa-google-plus" href="https://plus.google.com/share?url=http://mikbe.comjavascriptcitesting20160123zero-to-hero-with-end-to-end-testing.html"
                 onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                  <span class="hidden">Google+</span>
              </a>
          </section>

        </article>
      </div>
    </section>

    <section class="hero is-bold is-info">
      <div class="hero-content">
        <h2>You might also like ...</h2>
        <section class="container">
          <div class="columns">

            
              <div class="column">
                <a class="read-next-story" href="/javascript/react/relay/testing/2016/01/19/writing-simple-unit-tests-with-relay.html">
                  <section class="post">
                    <h2 class="title">Writing Simple Unit Tests with Relay</h2>
                    <p>Ever since I started using Relay in my React projects, code coverage has dropped significantly...</p>
                  </section>
                </a>
              </div>
            

            

          </div>
        </div>


      </div>
    </section>

    <footer class="footer">
  <div class="container">
    <h2 class="subtitle">Mikbe.com</h2>

    <div class="columns">

      <!-- Contact List -->
      <div class="column">
        <ul>
          <li>Mikbe.com</li>
          <li><a href="mailto:mikaelbrg@gmail.com">mikaelbrg@gmail.com</a></li>
        </ul>
      </div>

      <!-- Social Media List -->
      <div class="column">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/mikberg"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">mikberg</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/mikaelberg2k"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">mikaelberg2k</span></a>

          </li>
          
        </ul>
      </div>

      <!-- Site Description -->
      <div class="column is-half">
        <p>This is where I publish stuff I think others can find useful.
</p>
      </div>

    </div>
  </div>
</footer>


    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-3740312-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>

</html>
